<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®å¤æ— é™è¯·æ±‚é—®é¢˜</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .fix-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .fix-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .fix-header h1 {
            color: #e74c3c;
            margin-bottom: 10px;
        }
        
        .fix-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .btn.danger {
            background: #e74c3c;
        }
        
        .btn.danger:hover {
            background: #c0392b;
        }
        
        .btn.success {
            background: #27ae60;
        }
        
        .btn.success:hover {
            background: #219a52;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="fix-container">
        <div class="fix-header">
            <h1>ğŸ”§ ä¿®å¤æ— é™è¯·æ±‚é—®é¢˜</h1>
            <p>è¿™ä¸ªå·¥å…·å¯ä»¥å¸®åŠ©æ‚¨è¯Šæ–­å’Œä¿®å¤åšå®¢ç³»ç»Ÿä¸­çš„æ— é™è¯·æ±‚å¾ªç¯é—®é¢˜</p>
        </div>

        <div class="fix-section">
            <h3>ğŸš¨ ç´§æ€¥ä¿®å¤</h3>
            <p>å¦‚æœç³»ç»Ÿæ­£åœ¨å‘ç”Ÿæ— é™è¯·æ±‚ï¼Œè¯·ç«‹å³ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®ï¼š</p>
            <button class="btn danger" onclick="emergencyStop()">
                ğŸ›‘ ç´§æ€¥åœæ­¢æ‰€æœ‰è¯·æ±‚å’Œå®šæ—¶å™¨
            </button>
            <button class="btn danger" onclick="clearAllData()">
                ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æ•°æ®å¹¶é‡ç½®
            </button>
        </div>

        <div class="fix-section">
            <h3>ğŸ” è¯Šæ–­å·¥å…·</h3>
            <button class="btn" onclick="checkTimers()">æ£€æŸ¥æ´»åŠ¨å®šæ—¶å™¨</button>
            <button class="btn" onclick="checkEventListeners()">æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨</button>
            <button class="btn" onclick="checkLocalStorage()">æ£€æŸ¥æœ¬åœ°å­˜å‚¨</button>
            <button class="btn" onclick="monitorRequests()">å¼€å§‹ç›‘æ§è¯·æ±‚</button>
        </div>

        <div class="fix-section">
            <h3>ğŸ› ï¸ ä¿®å¤æ“ä½œ</h3>
            <button class="btn success" onclick="fixEventListeners()">ä¿®å¤äº‹ä»¶ç›‘å¬å™¨</button>
            <button class="btn success" onclick="resetAuthSystem()">é‡ç½®è®¤è¯ç³»ç»Ÿ</button>
            <button class="btn success" onclick="cleanupStorage()">æ¸…ç†å­˜å‚¨æ•°æ®</button>
            <button class="btn success" onclick="restartSystem()">é‡å¯ç³»ç»Ÿ</button>
        </div>

        <div class="fix-section">
            <h3>ğŸ“Š ç³»ç»ŸçŠ¶æ€</h3>
            <div id="system-status" class="status">æ­£åœ¨æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...</div>
        </div>

        <div class="fix-section">
            <h3>ğŸ“ æ“ä½œæ—¥å¿—</h3>
            <div id="fix-log" class="log">ç­‰å¾…æ“ä½œ...</div>
            <button class="btn" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
            <button class="btn" onclick="downloadLog()">ä¸‹è½½æ—¥å¿—</button>
        </div>

        <div class="fix-section">
            <h3>ğŸ”— å¿«é€Ÿå¯¼èˆª</h3>
            <button class="btn" onclick="goToDebug()">è°ƒè¯•é¡µé¢</button>
            <button class="btn" onclick="goToAdmin()">ç®¡ç†åå°</button>
            <button class="btn" onclick="goToHome()">è¿”å›é¦–é¡µ</button>
        </div>
    </div>

    <script>
        let fixLog = [];
        let requestMonitor = null;
        let timerIds = [];

        // æ·»åŠ æ—¥å¿—
        function addFixLog(message, type = 'info') {
            const timestamp = new Date().toLocaleString();
            const logEntry = `[${timestamp}] [${type.toUpperCase()}] ${message}`;
            fixLog.push(logEntry);
            
            const logElement = document.getElementById('fix-log');
            logElement.textContent = fixLog.join('\n');
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(logEntry);
        }

        // ç´§æ€¥åœæ­¢
        function emergencyStop() {
            addFixLog('æ‰§è¡Œç´§æ€¥åœæ­¢æ“ä½œ', 'warning');
            
            try {
                // åœæ­¢æ‰€æœ‰å®šæ—¶å™¨
                const highestTimeoutId = setTimeout(() => {}, 0);
                for (let i = 0; i <= highestTimeoutId; i++) {
                    clearTimeout(i);
                }
                
                const highestIntervalId = setInterval(() => {}, 1000);
                for (let i = 0; i <= highestIntervalId; i++) {
                    clearInterval(i);
                }
                clearInterval(highestIntervalId);
                
                // åœæ­¢æ‰€æœ‰fetchè¯·æ±‚
                if (window.fetch) {
                    window.fetch = function() {
                        addFixLog('é˜»æ­¢äº†ä¸€ä¸ªfetchè¯·æ±‚', 'warning');
                        return Promise.reject(new Error('è¯·æ±‚å·²è¢«ç´§æ€¥åœæ­¢'));
                    };
                }
                
                addFixLog('ç´§æ€¥åœæ­¢å®Œæˆ', 'success');
                updateSystemStatus('ç´§æ€¥åœæ­¢å·²æ‰§è¡Œ', 'warning');
                
            } catch (error) {
                addFixLog(`ç´§æ€¥åœæ­¢å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ¸…é™¤æ‰€æœ‰æ•°æ®
        function clearAllData() {
            if (confirm('è­¦å‘Šï¼šè¿™å°†æ¸…é™¤æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬æ–‡ç« ã€è®¾ç½®å’Œç™»å½•ä¿¡æ¯ï¼\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                try {
                    localStorage.clear();
                    sessionStorage.clear();
                    addFixLog('æ‰€æœ‰æ•°æ®å·²æ¸…é™¤', 'success');
                    updateSystemStatus('æ•°æ®å·²æ¸…é™¤ï¼Œè¯·åˆ·æ–°é¡µé¢', 'success');
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } catch (error) {
                    addFixLog(`æ¸…é™¤æ•°æ®å¤±è´¥: ${error.message}`, 'error');
                }
            }
        }

        // æ£€æŸ¥å®šæ—¶å™¨
        function checkTimers() {
            addFixLog('æ£€æŸ¥æ´»åŠ¨å®šæ—¶å™¨...', 'info');
            
            // è¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„æ£€æŸ¥ï¼Œå®é™…çš„å®šæ—¶å™¨æ£€æŸ¥æ¯”è¾ƒå¤æ‚
            const testTimeout = setTimeout(() => {}, 0);
            const testInterval = setInterval(() => {}, 1000);
            
            clearTimeout(testTimeout);
            clearInterval(testInterval);
            
            addFixLog(`æ£€æµ‹åˆ°çš„å®šæ—¶å™¨IDèŒƒå›´: setTimeout(${testTimeout}), setInterval(${testInterval})`, 'info');
            
            if (testTimeout > 1000 || testInterval > 100) {
                addFixLog('è­¦å‘Šï¼šæ£€æµ‹åˆ°å¤§é‡å®šæ—¶å™¨ï¼Œå¯èƒ½å­˜åœ¨æ³„æ¼', 'warning');
                updateSystemStatus('æ£€æµ‹åˆ°å®šæ—¶å™¨æ³„æ¼', 'warning');
            } else {
                addFixLog('å®šæ—¶å™¨æ•°é‡æ­£å¸¸', 'success');
            }
        }

        // æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨
        function checkEventListeners() {
            addFixLog('æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨...', 'info');
            
            // æ£€æŸ¥å¸¸è§çš„äº‹ä»¶ç›‘å¬å™¨
            const events = ['click', 'submit', 'input', 'change', 'storage', 'load'];
            let listenerCount = 0;
            
            events.forEach(eventType => {
                // è¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„æ£€æŸ¥
                const testElement = document.createElement('div');
                const testListener = () => {};
                
                testElement.addEventListener(eventType, testListener);
                testElement.removeEventListener(eventType, testListener);
                
                listenerCount++;
            });
            
            addFixLog(`æ£€æŸ¥äº† ${events.length} ç§äº‹ä»¶ç±»å‹`, 'info');
            addFixLog('äº‹ä»¶ç›‘å¬å™¨æ£€æŸ¥å®Œæˆ', 'success');
        }

        // æ£€æŸ¥æœ¬åœ°å­˜å‚¨
        function checkLocalStorage() {
            addFixLog('æ£€æŸ¥æœ¬åœ°å­˜å‚¨...', 'info');
            
            try {
                const keys = Object.keys(localStorage);
                let totalSize = 0;
                
                keys.forEach(key => {
                    const value = localStorage.getItem(key);
                    totalSize += key.length + (value ? value.length : 0);
                });
                
                addFixLog(`æœ¬åœ°å­˜å‚¨é¡¹ç›®æ•°: ${keys.length}`, 'info');
                addFixLog(`æœ¬åœ°å­˜å‚¨å¤§å°: ${(totalSize / 1024).toFixed(2)} KB`, 'info');
                
                // æ£€æŸ¥å¯èƒ½æœ‰é—®é¢˜çš„æ•°æ®
                const problemKeys = keys.filter(key => 
                    key.includes('temp') || 
                    key.includes('cache') || 
                    localStorage.getItem(key).length > 100000
                );
                
                if (problemKeys.length > 0) {
                    addFixLog(`å‘ç°å¯èƒ½æœ‰é—®é¢˜çš„å­˜å‚¨é¡¹: ${problemKeys.join(', ')}`, 'warning');
                }
                
                addFixLog('æœ¬åœ°å­˜å‚¨æ£€æŸ¥å®Œæˆ', 'success');
                
            } catch (error) {
                addFixLog(`æ£€æŸ¥æœ¬åœ°å­˜å‚¨å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ç›‘æ§è¯·æ±‚
        function monitorRequests() {
            if (requestMonitor) {
                addFixLog('è¯·æ±‚ç›‘æ§å·²åœ¨è¿è¡Œ', 'warning');
                return;
            }
            
            addFixLog('å¼€å§‹ç›‘æ§è¯·æ±‚...', 'info');
            
            const originalFetch = window.fetch;
            let requestCount = 0;
            
            window.fetch = function(...args) {
                requestCount++;
                addFixLog(`è¯·æ±‚ #${requestCount}: ${args[0]}`, 'info');
                
                if (requestCount > 50) {
                    addFixLog('è­¦å‘Šï¼šè¯·æ±‚æ•°é‡è¿‡å¤šï¼Œå¯èƒ½å­˜åœ¨æ— é™å¾ªç¯', 'error');
                    updateSystemStatus('æ£€æµ‹åˆ°å¼‚å¸¸è¯·æ±‚é¢‘ç‡', 'error');
                }
                
                return originalFetch.apply(this, args);
            };
            
            requestMonitor = true;
            addFixLog('è¯·æ±‚ç›‘æ§å·²å¯åŠ¨', 'success');
        }

        // ä¿®å¤äº‹ä»¶ç›‘å¬å™¨
        function fixEventListeners() {
            addFixLog('ä¿®å¤äº‹ä»¶ç›‘å¬å™¨...', 'info');
            
            try {
                // é‡æ–°åŠ è½½é¡µé¢æ˜¯æœ€å½»åº•çš„ä¿®å¤æ–¹æ³•
                if (confirm('ä¿®å¤äº‹ä»¶ç›‘å¬å™¨éœ€è¦é‡æ–°åŠ è½½é¡µé¢ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) {
                    addFixLog('é‡æ–°åŠ è½½é¡µé¢ä»¥ä¿®å¤äº‹ä»¶ç›‘å¬å™¨', 'success');
                    window.location.reload();
                }
            } catch (error) {
                addFixLog(`ä¿®å¤äº‹ä»¶ç›‘å¬å™¨å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é‡ç½®è®¤è¯ç³»ç»Ÿ
        function resetAuthSystem() {
            addFixLog('é‡ç½®è®¤è¯ç³»ç»Ÿ...', 'info');
            
            try {
                localStorage.removeItem('blog_auth_settings');
                localStorage.removeItem('blog_session');
                addFixLog('è®¤è¯ç³»ç»Ÿå·²é‡ç½®', 'success');
                updateSystemStatus('è®¤è¯ç³»ç»Ÿå·²é‡ç½®', 'success');
            } catch (error) {
                addFixLog(`é‡ç½®è®¤è¯ç³»ç»Ÿå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ¸…ç†å­˜å‚¨æ•°æ®
        function cleanupStorage() {
            addFixLog('æ¸…ç†å­˜å‚¨æ•°æ®...', 'info');
            
            try {
                const keys = Object.keys(localStorage);
                let cleanedCount = 0;
                
                keys.forEach(key => {
                    if (key.includes('temp') || key.includes('cache') || key.includes('debug')) {
                        localStorage.removeItem(key);
                        cleanedCount++;
                    }
                });
                
                addFixLog(`æ¸…ç†äº† ${cleanedCount} ä¸ªä¸´æ—¶å­˜å‚¨é¡¹`, 'success');
                updateSystemStatus('å­˜å‚¨æ•°æ®å·²æ¸…ç†', 'success');
            } catch (error) {
                addFixLog(`æ¸…ç†å­˜å‚¨æ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é‡å¯ç³»ç»Ÿ
        function restartSystem() {
            if (confirm('ç¡®å®šè¦é‡å¯ç³»ç»Ÿå—ï¼Ÿè¿™å°†åˆ·æ–°é¡µé¢ã€‚')) {
                addFixLog('é‡å¯ç³»ç»Ÿ...', 'info');
                window.location.reload();
            }
        }

        // æ›´æ–°ç³»ç»ŸçŠ¶æ€
        function updateSystemStatus(message, type) {
            const statusElement = document.getElementById('system-status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

        // æ¸…é™¤æ—¥å¿—
        function clearLog() {
            fixLog = [];
            document.getElementById('fix-log').textContent = 'æ—¥å¿—å·²æ¸…é™¤';
            addFixLog('æ—¥å¿—å·²æ¸…é™¤');
        }

        // ä¸‹è½½æ—¥å¿—
        function downloadLog() {
            const blob = new Blob([fixLog.join('\n')], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fix-log-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            addFixLog('æ—¥å¿—ä¸‹è½½å®Œæˆ');
        }

        // å¯¼èˆªå‡½æ•°
        function goToDebug() {
            window.location.href = 'debug.html';
        }

        function goToAdmin() {
            window.location.href = 'admin.html';
        }

        function goToHome() {
            window.location.href = 'index.html';
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addFixLog('ä¿®å¤å·¥å…·åˆå§‹åŒ–å®Œæˆ');
            updateSystemStatus('ç³»ç»ŸçŠ¶æ€æ£€æŸ¥ä¸­...', 'info');
            
            // è‡ªåŠ¨æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
            setTimeout(() => {
                checkTimers();
                checkLocalStorage();
                updateSystemStatus('ç³»ç»Ÿæ£€æŸ¥å®Œæˆ', 'success');
            }, 1000);
        });
    </script>
</body>
</html>
