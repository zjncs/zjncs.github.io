<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç´§æ€¥é‡å¯ç³»ç»Ÿ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ff4757;
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .emergency-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 600px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        .emergency-icon {
            font-size: 4em;
            margin-bottom: 20px;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .emergency-title {
            font-size: 2.5em;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .emergency-message {
            font-size: 1.2em;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .emergency-btn {
            background: white;
            color: #ff4757;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .emergency-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        .emergency-btn.secondary {
            background: transparent;
            color: white;
            border: 2px solid white;
        }
        
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            font-weight: 500;
        }
        
        .countdown {
            font-size: 3em;
            font-weight: bold;
            margin: 20px 0;
            color: #ffd700;
        }
        
        .log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
            text-align: left;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="emergency-container">
        <div class="emergency-icon">ğŸš¨</div>
        <h1 class="emergency-title">ç´§æ€¥ç³»ç»Ÿé‡å¯</h1>
        <p class="emergency-message">
            æ£€æµ‹åˆ°ç³»ç»Ÿæ­£åœ¨å‘ç”Ÿæ— é™GETè¯·æ±‚å¾ªç¯<br>
            ç«‹å³æ‰§è¡Œç´§æ€¥åœæ­¢å’Œé‡å¯æ“ä½œ
        </p>
        
        <div id="status" class="status">å‡†å¤‡æ‰§è¡Œç´§æ€¥æ“ä½œ...</div>
        
        <div class="countdown" id="countdown">5</div>
        
        <button class="emergency-btn" onclick="emergencyStop()">
            ğŸ›‘ ç«‹å³åœæ­¢æ‰€æœ‰è¯·æ±‚
        </button>
        
        <button class="emergency-btn secondary" onclick="fullRestart()">
            ğŸ”„ å®Œæ•´é‡å¯ç³»ç»Ÿ
        </button>
        
        <button class="emergency-btn secondary" onclick="cancelOperation()">
            âŒ å–æ¶ˆæ“ä½œ
        </button>
        
        <div class="log" id="emergency-log">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <script>
        let emergencyLog = [];
        let countdownTimer = null;
        let autoStopTimer = null;

        function addEmergencyLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            emergencyLog.push(logEntry);
            
            const logElement = document.getElementById('emergency-log');
            logElement.textContent = emergencyLog.join('\n');
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(logEntry);
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        function emergencyStop() {
            addEmergencyLog('ğŸš¨ æ‰§è¡Œç´§æ€¥åœæ­¢æ“ä½œ');
            updateStatus('æ­£åœ¨åœæ­¢æ‰€æœ‰è¯·æ±‚å’Œå®šæ—¶å™¨...');
            
            try {
                // 1. åœæ­¢æ‰€æœ‰å®šæ—¶å™¨
                addEmergencyLog('åœæ­¢æ‰€æœ‰setTimeoutå®šæ—¶å™¨...');
                const highestTimeoutId = setTimeout(() => {}, 0);
                for (let i = 0; i <= highestTimeoutId; i++) {
                    clearTimeout(i);
                }
                
                addEmergencyLog('åœæ­¢æ‰€æœ‰setIntervalå®šæ—¶å™¨...');
                const highestIntervalId = setInterval(() => {}, 1000);
                for (let i = 0; i <= highestIntervalId; i++) {
                    clearInterval(i);
                }
                clearInterval(highestIntervalId);
                
                // 2. é˜»æ­¢æ‰€æœ‰fetchè¯·æ±‚
                addEmergencyLog('é˜»æ­¢æ‰€æœ‰fetchè¯·æ±‚...');
                const originalFetch = window.fetch;
                window.fetch = function() {
                    addEmergencyLog('âŒ é˜»æ­¢äº†ä¸€ä¸ªfetchè¯·æ±‚');
                    return Promise.reject(new Error('è¯·æ±‚å·²è¢«ç´§æ€¥åœæ­¢'));
                };
                
                // 3. é˜»æ­¢æ‰€æœ‰XMLHttpRequest
                addEmergencyLog('é˜»æ­¢æ‰€æœ‰XMLHttpRequest...');
                const originalXHR = window.XMLHttpRequest;
                window.XMLHttpRequest = function() {
                    addEmergencyLog('âŒ é˜»æ­¢äº†ä¸€ä¸ªXMLHttpRequest');
                    throw new Error('XMLHttpRequestå·²è¢«ç´§æ€¥åœæ­¢');
                };
                
                // 4. ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
                addEmergencyLog('æ¸…ç†äº‹ä»¶ç›‘å¬å™¨...');
                const allElements = document.querySelectorAll('*');
                allElements.forEach(element => {
                    const newElement = element.cloneNode(true);
                    if (element.parentNode) {
                        element.parentNode.replaceChild(newElement, element);
                    }
                });
                
                // 5. åœæ­¢æ‰€æœ‰åŠ¨ç”»
                addEmergencyLog('åœæ­¢æ‰€æœ‰åŠ¨ç”»...');
                const animations = document.getAnimations();
                animations.forEach(animation => animation.cancel());
                
                // 6. æ¸…ç†å¯èƒ½çš„é—®é¢˜è„šæœ¬
                addEmergencyLog('ç§»é™¤å¤–éƒ¨è„šæœ¬...');
                const scripts = document.querySelectorAll('script[src]');
                scripts.forEach(script => {
                    if (script.src.includes('live2d') || 
                        script.src.includes('cdn.jsdelivr.net') ||
                        script.src.includes('cdnjs.cloudflare.com')) {
                        script.remove();
                        addEmergencyLog(`ç§»é™¤è„šæœ¬: ${script.src}`);
                    }
                });
                
                addEmergencyLog('âœ… ç´§æ€¥åœæ­¢æ“ä½œå®Œæˆ');
                updateStatus('æ‰€æœ‰è¯·æ±‚å’Œå®šæ—¶å™¨å·²åœæ­¢');
                
                // æ˜¾ç¤ºé‡å¯é€‰é¡¹
                setTimeout(() => {
                    if (confirm('ç´§æ€¥åœæ­¢å®Œæˆï¼æ˜¯å¦è¦æ¸…é™¤æ‰€æœ‰æ•°æ®å¹¶é‡å¯ç³»ç»Ÿï¼Ÿ')) {
                        fullRestart();
                    }
                }, 2000);
                
            } catch (error) {
                addEmergencyLog(`âŒ ç´§æ€¥åœæ­¢å¤±è´¥: ${error.message}`);
                updateStatus('ç´§æ€¥åœæ­¢å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢');
            }
        }

        function fullRestart() {
            addEmergencyLog('ğŸ”„ å¼€å§‹å®Œæ•´é‡å¯ç³»ç»Ÿ');
            updateStatus('æ­£åœ¨æ¸…é™¤æ‰€æœ‰æ•°æ®...');
            
            try {
                // æ¸…é™¤æ‰€æœ‰å­˜å‚¨
                localStorage.clear();
                sessionStorage.clear();
                addEmergencyLog('âœ… æœ¬åœ°å­˜å‚¨å·²æ¸…é™¤');
                
                // æ¸…é™¤æ‰€æœ‰ç¼“å­˜
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => {
                            caches.delete(name);
                            addEmergencyLog(`æ¸…é™¤ç¼“å­˜: ${name}`);
                        });
                    });
                }
                
                addEmergencyLog('ğŸ”„ å‡†å¤‡é‡æ–°åŠ è½½é¡µé¢...');
                updateStatus('ç³»ç»Ÿå°†åœ¨3ç§’åé‡å¯...');
                
                // å€’è®¡æ—¶é‡å¯
                let countdown = 3;
                const countdownElement = document.getElementById('countdown');
                const countdownInterval = setInterval(() => {
                    countdownElement.textContent = countdown;
                    countdown--;
                    
                    if (countdown < 0) {
                        clearInterval(countdownInterval);
                        addEmergencyLog('ğŸš€ é‡å¯ç³»ç»Ÿ...');
                        window.location.href = 'index.html';
                    }
                }, 1000);
                
            } catch (error) {
                addEmergencyLog(`âŒ é‡å¯å¤±è´¥: ${error.message}`);
                updateStatus('é‡å¯å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢');
            }
        }

        function cancelOperation() {
            addEmergencyLog('âŒ ç”¨æˆ·å–æ¶ˆæ“ä½œ');
            updateStatus('æ“ä½œå·²å–æ¶ˆ');
            
            if (countdownTimer) {
                clearTimeout(countdownTimer);
            }
            if (autoStopTimer) {
                clearTimeout(autoStopTimer);
            }
            
            // æä¾›è¿”å›é€‰é¡¹
            setTimeout(() => {
                if (confirm('æ˜¯å¦è¿”å›ä¸»é¡µï¼Ÿ')) {
                    window.location.href = 'index.html';
                }
            }, 1000);
        }

        // è‡ªåŠ¨å€’è®¡æ—¶
        function startCountdown() {
            let count = 5;
            const countdownElement = document.getElementById('countdown');
            
            countdownTimer = setInterval(() => {
                count--;
                countdownElement.textContent = count;
                
                if (count <= 0) {
                    clearInterval(countdownTimer);
                    addEmergencyLog('â° è‡ªåŠ¨æ‰§è¡Œç´§æ€¥åœæ­¢');
                    emergencyStop();
                }
            }, 1000);
        }

        // é¡µé¢åŠ è½½æ—¶ç«‹å³å¼€å§‹
        document.addEventListener('DOMContentLoaded', function() {
            addEmergencyLog('ğŸš¨ ç´§æ€¥é‡å¯å·¥å…·å·²å¯åŠ¨');
            updateStatus('æ£€æµ‹åˆ°æ— é™è¯·æ±‚ï¼Œå‡†å¤‡è‡ªåŠ¨åœæ­¢...');
            
            // ç«‹å³æ‰§è¡Œç´§æ€¥åœæ­¢
            autoStopTimer = setTimeout(() => {
                addEmergencyLog('ğŸ¤– è‡ªåŠ¨æ‰§è¡Œç´§æ€¥åœæ­¢æ“ä½œ');
                emergencyStop();
            }, 5000);
            
            // å¼€å§‹å€’è®¡æ—¶
            startCountdown();
        });

        // é˜²æ­¢é¡µé¢è¢«å…¶ä»–è„šæœ¬å¹²æ‰°
        window.addEventListener('beforeunload', function() {
            addEmergencyLog('ğŸ”„ é¡µé¢å³å°†é‡æ–°åŠ è½½');
        });

        // é˜»æ­¢æ‰€æœ‰å¯èƒ½çš„ç½‘ç»œè¯·æ±‚
        if (navigator.serviceWorker) {
            navigator.serviceWorker.getRegistrations().then(registrations => {
                registrations.forEach(registration => {
                    registration.unregister();
                    addEmergencyLog('ç§»é™¤Service Worker');
                });
            });
        }
    </script>
</body>
</html>
